name: Update JSON file

on: [push, workflow_dispatch]

jobs:
  update_file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.TOKEN_THING }}

      - name: Set up Git user
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Modify JSON file
        run: |
            import json
            import subprocess
            
            # Define the JSON file
            json_file = "test.json"
      
            # List of keys and values to update
            new_data = {
                "key1": "value1",
                "key2": "test",
            }
      
            # Read the existing JSON file
            try:
                with open(json_file, "r") as f:
                    current_data = json.load(f)
            except (FileNotFoundError, json.JSONDecodeError):
                current_data = {}
      
            # Update the JSON file based on new_data
            updated_data = {k: new_data[k] for k in new_data}
      
            # Write back the modified JSON
            with open(json_file, "w") as f:
                json.dump(updated_data, f, indent=4)
      
            # Optionally, commit changes here (or in the next step)
            subprocess.run(["git", "config", "--global", "user.name", "github-actions"])
            subprocess.run(["git", "config", "--global", "user.email", "github-actions@github.com"])
            subprocess.run(["git", "add", json_file])
            # Commit here; you could also move this to a separate step if you prefer.
            commit_result = subprocess.run(["git", "commit", "-m", "Update JSON file"])
            # Exit if commit fails? Otherwise, continue.
            if commit_result.returncode != 0:
                print("Nothing to commit in this step.")
            else:
                subprocess.run(["git", "push"])
        shell: python

      - name: Commit and push changes
        run: |
          git add test.json
          # Check if there are any changes before committing
          if ! git diff-index --quiet HEAD --; then
            git commit -m "Updated JSON"
            git push https://Axolotian-dev:${{ secrets.TOKEN_THING }}@github.com/${{ github.repository }}.git
          else
            echo "No changes to commit."
          fi
